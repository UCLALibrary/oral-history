version: '2'
services:
  postgres:
    image: postgres
    env_file:
      - .env
      - .env.development
    ports:
      - "5432"
    volumes:
      - 'postgres:/var/lib/postgresql/data'

  solr:
    image: "${REGISTRY_HOST}${REGISTRY_URI}:${TAG}"
    environment:
      - RAILS_ENV=production
      - RACK_ENV=production
      - PASSENGER_APP_ENV=production
    restart: unless-stopped
    command: /sbin/setuser app bash -l -c 'cd /home/app/webapp && bundle exec solr_wrapper'
    ports:
      - "8983"
    labels:
      rap.host: ${SITE_URI}
      rap.le_host: ${SITE_URI}
      rap.le_test: true
      io.rancher.container.pull_image: always
    env_file:
      - .env
      - .env.production
  web:
    image: "${REGISTRY_HOST}${REGISTRY_URI}:${TAG}"
    environment:
      - RAILS_ENV=production
      - RACK_ENV=production
      - PASSENGER_APP_ENV=production
    restart: unless-stopped
    ports:
      - "80"
    labels:
      rap.host: ${SITE_URI}
      rap.le_host: ${SITE_URI}
      rap.le_test: true
      io.rancher.container.pull_image: always
    env_file:
      - .env
      - .env.production
    depends_on:
      - postgres
      - solr
  # NOTE: THIS IS FOR SCALING OUT IMPORT/PROCESS (SPEICIFCALLY OF PEAKS)
  # EVEN IF YOU KILL THIS CONTAINER, THERE IS A SINGLE WORKER IN THE WEB CONTAINER
  delayed_job:
    image: "${REGISTRY_HOST}${REGISTRY_URI}:${TAG}"
    environment:
      - RAILS_ENV=production
      - RACK_ENV=production
      - PASSENGER_APP_ENV=production
    restart: unless-stopped
    command: bin/delayed_job run
    labels:
      io.rancher.container.pull_image: always
    env_file:
      - .env
      - .env.production
    depends_on:
      - postgres
      - solr
    depends_on:
      - postgres
      - solr

volumes:
  postgres:
  solr:
